<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financeiro Completo e Funcional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        ::placeholder { color: #64748b; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .card { background-color: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; padding: 1.5rem; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-semibold; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; cursor: pointer; }
        .btn:disabled { background-color: #334155; color: #94a3b8; cursor: not-allowed; }
        .btn-primary { background-color: #3b82f6; color: white; } .btn-primary:hover:not(:disabled) { background-color: #2563eb; }
        .btn-secondary { background-color: #475569; color: white; } .btn-secondary:hover:not(:disabled) { background-color: #64748b; }
        .btn-danger { background-color: #ef4444; color: white; } .btn-danger:hover:not(:disabled) { background-color: #dc2626; }
        .modal-overlay { display: none; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(4px); animation: fadeIn 0.3s ease-out; }
        .modal-overlay.flex { display: flex; }
        .list-item-controls { opacity: 0; transition: opacity 0.2s; }
        .group:hover .list-item-controls { opacity: 1; }
        .icon { width: 1.25rem; height: 1.25rem; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-white text-center">Dashboard Financeiro</h1>
            <div class="flex items-center justify-center mt-4 text-2xl font-semibold">
                <button id="prev-month" class="p-2 rounded-full hover:bg-slate-700">&lt;</button>
                <h2 id="current-month-display" class="mx-4 w-52 text-center"></h2>
                <button id="next-month" class="p-2 rounded-full hover:bg-slate-700">&gt;</button>
            </div>
            <div class="flex flex-wrap justify-center mt-4 gap-4">
                <button id="open-transaction-modal-btn" class="btn btn-primary"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>Nova Transação</button>
                <button id="open-transfer-modal-btn" class="btn btn-primary"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>Transferência</button>
                <button id="manage-accounts-btn" class="btn btn-secondary"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H4a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>Gerir Contas</button>
                <button id="manage-categories-btn" class="btn btn-secondary"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>Categorias</button>
                <button id="manage-goals-btn" class="btn btn-secondary"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>Gerir Metas</button>
            </div>
        </header>

        <main id="app-content"></main>
    </div>

    <div id="modal-container"></div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let state = {
            currentDate: new Date(),
            allTransactions: [],
            categories: {},
            accounts: [],
            goals: [],
        };
        const APP_VERSION = 'v10_complete_fix';

        const el = {
            currentMonthDisplay: document.getElementById('current-month-display'),
            appContent: document.getElementById('app-content'),
            modalContainer: document.getElementById('modal-container'),
        };

        const formatCurrency = (value) => (value != null ? value : 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const getTodayISO = () => new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().split("T")[0];

        const saveData = () => {
            localStorage.setItem(`financeApp_data_${APP_VERSION}`, JSON.stringify(state));
        };

        const loadData = () => {
            const savedData = JSON.parse(localStorage.getItem(`financeApp_data_${APP_VERSION}`));
            if (savedData) {
                state = { ...state, ...savedData, currentDate: new Date(savedData.currentDate) };
            }
            if (!state.categories || Object.keys(state.categories).length === 0) {
                 state.categories = {
                    receita: ['Salário', 'Freelance', 'Investimentos', 'Outros'],
                    despesa: ['Alimentação', 'Moradia', 'Transporte', 'Lazer', 'Saúde', 'Contas', 'Aportes para Metas', 'Outros']
                };
            }
        };
        
        const updateAndRender = () => {
            saveData();
            renderApp();
        };

        const calculateAccountBalance = (accountId) => {
            const account = state.accounts.find(a => a.id === accountId);
            if (!account) return 0;
            let balance = account.initialBalance;
            state.allTransactions.forEach(t => {
                if ((t.tipo === 'receita' && t.accountId === accountId) || (t.tipo === 'transferencia' && t.toAccountId === accountId)) balance += t.valor;
                if ((t.tipo === 'despesa' && t.accountId === accountId) || (t.tipo === 'transferencia' && t.fromAccountId === accountId)) balance -= t.valor;
            });
            return balance;
        };

        const calculateGoalProgress = (goalId) => {
            return state.allTransactions
                .filter(t => t.goalId === goalId && t.categoria === 'Aportes para Metas')
                .reduce((sum, t) => sum + t.valor, 0);
        };
        
        const showModal = (htmlContent) => {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-50';
            modal.innerHTML = htmlContent;
            el.modalContainer.appendChild(modal);
            return modal;
        };

        const hideModal = (modal) => modal?.remove();

        const renderApp = () => {
            const appContentHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="card lg:col-span-2">
                        <h3 class="text-xl font-semibold text-white mb-4">Contas</h3>
                        <div id="accounts-panel" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
                    </div>
                    <div class="card text-center flex flex-col justify-center">
                        <h3 class="text-lg text-slate-400">Saldo Total</h3>
                        <p id="total-balance" class="text-4xl font-bold text-green-400 mt-2"></p>
                    </div>
                </div>
                <div class="card mb-6">
                    <h3 class="text-xl font-semibold text-white mb-4">As Minhas Metas (Cofrinhos)</h3>
                    <div id="goals-panel" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
                <div class="card">
                     <h3 class="text-xl font-semibold mb-3 text-white">Transações do Mês</h3>
                    <div id="transactions-list" class="space-y-2 max-h-96 overflow-y-auto pr-2"></div>
                </div>`;

            el.appContent.innerHTML = appContentHTML;
            
            el.currentMonthDisplay.textContent = state.currentDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            
            document.getElementById('open-transaction-modal-btn').disabled = state.accounts.length === 0;
            document.getElementById('open-transfer-modal-btn').disabled = state.accounts.length < 2;
            
            renderAccountsPanel();
            renderGoalsPanel();
            renderTransactionList();
        };

        const renderAccountsPanel = () => {
            const panel = document.getElementById('accounts-panel');
            if (state.accounts.length === 0) {
                panel.innerHTML = `<div class="col-span-full text-center text-slate-400">Nenhuma conta criada. Clique em "Gerir Contas" para começar.</div>`;
                document.getElementById('total-balance').textContent = formatCurrency(0);
                return;
            }
            panel.innerHTML = state.accounts.map(acc => `
                <div class="card !p-4">
                    <p class="font-semibold text-slate-300">${acc.name}</p>
                    <p class="text-xl font-bold ${calculateAccountBalance(acc.id) >= 0 ? 'text-green-400' : 'text-red-400'}">${formatCurrency(calculateAccountBalance(acc.id))}</p>
                </div>
            `).join('');
            document.getElementById('total-balance').textContent = formatCurrency(state.accounts.reduce((sum, acc) => sum + calculateAccountBalance(acc.id), 0));
        };

        const renderGoalsPanel = () => {
            const panel = document.getElementById('goals-panel');
            if (state.goals.length === 0) {
                panel.innerHTML = `<p class="text-slate-400 text-center col-span-full py-4">Nenhuma meta definida. Clique em "Gerir Metas" para criar o seu primeiro cofrinho!</p>`;
                return;
            }
            panel.innerHTML = state.goals.map(goal => {
                const savedAmount = calculateGoalProgress(goal.id);
                const percentage = goal.targetAmount > 0 ? (savedAmount / goal.targetAmount) * 100 : 0;
                return `<div class="card !p-4 flex flex-col"><div class="flex-grow"><div class="flex justify-between items-start"><div><p class="font-bold text-lg text-white">${goal.name}</p><p class="text-sm text-slate-400">Meta: ${formatCurrency(goal.targetAmount)}</p></div><span class="text-2xl">🎯</span></div><p class="text-sm font-semibold text-green-400 mt-2">${formatCurrency(savedAmount)} guardados</p><div class="w-full bg-slate-700 rounded-full h-2.5 my-2"><div class="bg-green-500 h-2.5 rounded-full" style="width: ${Math.min(percentage, 100)}%"></div></div></div><button class="btn btn-secondary w-full mt-3 contribute-btn" data-id="${goal.id}" ${state.accounts.length === 0 ? 'disabled' : ''}>Contribuir</button></div>`;
            }).join('');
        };
        
        const renderTransactionList = () => {
            const listEl = document.getElementById('transactions-list');
            const transactionsForMonth = state.allTransactions.filter(t => new Date(t.data).getUTCFullYear() === state.currentDate.getUTCFullYear() && new Date(t.data).getUTCMonth() === state.currentDate.getUTCMonth());
            transactionsForMonth.sort((a,b) => new Date(b.data) - new Date(a.data));

            if (transactionsForMonth.length === 0) {
                listEl.innerHTML = `<p class="text-slate-400 text-center py-8">Nenhuma transação este mês.</p>`;
                return;
            }
            listEl.innerHTML = transactionsForMonth.map(t => {
                let details, amountClass, symbol;
                if (t.tipo === 'transferencia') {
                    const fromAcc = state.accounts.find(a => a.id === t.fromAccountId)?.name || 'N/A';
                    const toAcc = state.accounts.find(a => a.id === t.toAccountId)?.name || 'N/A';
                    details = `<p class="font-semibold text-slate-200">${t.nome}</p><p class="text-sm text-slate-400">De ${fromAcc} → Para ${toAcc}</p>`;
                    amountClass = 'text-slate-400'; symbol = '↔️';
                } else {
                    const accName = state.accounts.find(a => a.id === t.accountId)?.name || 'N/A';
                    details = `<p class="font-semibold text-slate-200">${t.nome}</p><p class="text-sm text-slate-400">${t.categoria} • ${accName}</p>`;
                    amountClass = t.tipo === 'receita' ? 'text-green-400' : 'text-red-400';
                    symbol = t.tipo === 'receita' ? '🟢' : '🔴';
                }
                return `<div class="group grid grid-cols-3 items-center bg-slate-800 p-3 rounded-md gap-4"><div class="col-span-2 flex items-center"><span class="mr-3 text-lg">${symbol}</span><div>${details}</div></div><div class="flex items-center justify-end"><span class="font-semibold text-lg ${amountClass}">${formatCurrency(t.valor)}</span><div class="list-item-controls flex items-center ml-4"><button class="edit-btn p-1" data-id="${t.id}"><svg class="icon text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg></button><button class="delete-btn p-1" data-id="${t.id}"><svg class="icon text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div></div></div>`;
            }).join('');
        };
        
        const openTransactionModal = (t = null) => {
            const accountOptions = state.accounts.map(a => `<option value="${a.id}" ${t?.accountId === a.id ? 'selected' : ''}>${a.name}</option>`).join('');
            const html = `<div class="card w-full max-w-lg"><h2 class="text-2xl font-bold mb-4">${t ? 'Editar' : 'Nova'} Transação</h2><form id="transaction-form" class="space-y-4"><input type="hidden" id="transaction-id" value="${t?.id || ''}"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label>Tipo</label><div class="flex mt-1"><label class="flex-1"><input type="radio" name="type" value="despesa" class="sr-only peer" ${!t || t.tipo === 'despesa' ? 'checked' : ''}><span class="w-full text-center block p-2 rounded-l-md bg-slate-700 peer-checked:bg-red-500">Despesa</span></label><label class="flex-1"><input type="radio" name="type" value="receita" class="sr-only peer" ${t?.tipo === 'receita' ? 'checked' : ''}><span class="w-full text-center block p-2 rounded-r-md bg-slate-700 peer-checked:bg-green-500">Receita</span></label></div></div><div><label for="transaction-name">Descrição</label><input type="text" id="transaction-name" value="${t?.nome || ''}" required class="w-full mt-1 bg-slate-700 rounded h-10 px-3"></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label for="transaction-value">Valor</label><input type="number" step="0.01" id="transaction-value" value="${t?.valor || ''}" required class="w-full mt-1 bg-slate-700 rounded h-10 px-3"></div><div><label for="transaction-date">Data</label><input type="date" id="transaction-date" value="${t?.data || getTodayISO()}" required class="w-full mt-1 bg-slate-700 rounded h-10 px-3"></div><div><label for="transaction-account">Conta</label><select id="transaction-account" required class="w-full mt-1 bg-slate-700 rounded h-10 px-3">${accountOptions}</select></div></div><div><label for="transaction-category">Categoria</label><select id="transaction-category" required class="w-full mt-1 bg-slate-700 rounded h-10 px-3"></select></div><div class="flex justify-end gap-4 pt-4"><button type="button" class="btn btn-secondary close-modal-btn">Cancelar</button><button type="submit" class="btn btn-primary">${t ? 'Salvar' : 'Adicionar'}</button></div></form></div>`;
            const modal = showModal(html);
            
            const typeRadios = modal.querySelectorAll('input[name="type"]');
            const categorySelect = modal.querySelector('#transaction-category');
            const updateCategories = () => {
                const selectedType = modal.querySelector('input[name="type"]:checked').value;
                categorySelect.innerHTML = state.categories[selectedType].map(c => `<option value="${c}" ${t?.categoria === c ? 'selected' : ''}>${c}</option>`).join('');
            };
            typeRadios.forEach(radio => radio.onchange = updateCategories);
            updateCategories();
            
            modal.querySelector('.close-modal-btn').onclick = () => hideModal(modal);
            modal.querySelector('form').onsubmit = (e) => {
                e.preventDefault();
                const form = e.target;
                const id = form['transaction-id'].value;
                const transaction = {
                    id: id ? Number(id) : Date.now(),
                    tipo: form.type.value,
                    nome: form['transaction-name'].value.trim(),
                    valor: parseFloat(form['transaction-value'].value),
                    data: form['transaction-date'].value,
                    accountId: Number(form['transaction-account'].value),
                    categoria: form['transaction-category'].value
                };
                if (id) {
                    state.allTransactions = state.allTransactions.map(tr => tr.id === transaction.id ? transaction : tr);
                } else {
                    state.allTransactions.push(transaction);
                }
                updateAndRender();
                hideModal(modal);
            };
        };

        const openTransferModal = (t = null) => {
            const accountOptions = state.accounts.map(a => `<option value="${a.id}" ${t?.fromAccountId === a.id || t?.toAccountId === a.id ? 'selected':''}>${a.name}</option>`).join('');
            const html = `<div class="card w-full max-w-lg"><h2 class="text-2xl font-bold mb-4">${t ? 'Editar' : 'Nova'} Transferência</h2><form id="transfer-form" class="space-y-4"><input type="hidden" id="transfer-id" value="${t?.id || ''}"><div><label for="transfer-name">Descrição</label><input type="text" id="transfer-name" value="${t?.nome || 'Transferência entre contas'}" required class="w-full mt-1 bg-slate-700 rounded h-10 px-3"></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="transfer-from">De</label><select id="transfer-from" required class="w-full mt-1 bg-slate-700 rounded h-10 px-3">${accountOptions}</select></div><div><label for="transfer-to">Para</label><select id="transfer-to" required class="w-full mt-1 bg-slate-700 rounded h-10 px-3">${accountOptions}</select></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="transfer-value">Valor</label><input type="number" step="0.01" id="transfer-value" value="${t?.valor || ''}" required class="w-full mt-1 bg-slate-700 rounded h-10 px-3"></div><div><label for="transfer-date">Data</label><input type="date" id="transfer-date" value="${t?.data || getTodayISO()}" required class="w-full mt-1 bg-slate-700 rounded h-10 px-3"></div></div><div class="flex justify-end gap-4 pt-4"><button type="button" class="btn btn-secondary close-modal-btn">Cancelar</button><button type="submit" class="btn btn-primary">${t ? 'Salvar' : 'Adicionar'}</button></div></form></div>`;
            const modal = showModal(html);

            modal.querySelector('.close-modal-btn').onclick = () => hideModal(modal);
            modal.querySelector('form').onsubmit = (e) => {
                e.preventDefault();
                const form = e.target;
                const fromAccountId = Number(form['transfer-from'].value);
                const toAccountId = Number(form['transfer-to'].value);
                if(fromAccountId === toAccountId) {
                    alert('As contas de origem e destino devem ser diferentes.');
                    return;
                }
                const id = form['transfer-id'].value;
                const transfer = {
                    id: id ? Number(id) : Date.now(),
                    tipo: 'transferencia',
                    nome: form['transfer-name'].value.trim(),
                    valor: parseFloat(form['transfer-value'].value),
                    data: form['transfer-date'].value,
                    fromAccountId,
                    toAccountId,
                };
                if (id) {
                    state.allTransactions = state.allTransactions.map(tr => tr.id === transfer.id ? transfer : tr);
                } else {
                    state.allTransactions.push(transfer);
                }
                updateAndRender();
                hideModal(modal);
            };
        };
        
        const openAccountsModal = () => {
             const html = `<div class="card w-full max-w-lg"><h2 class="text-2xl font-bold mb-4">Gerir Contas</h2><div id="accounts-list-modal" class="mb-4 max-h-48 overflow-y-auto pr-2"></div><h3 class="font-semibold mb-2 text-lg">Nova / Editar Conta</h3><form id="account-form" class="flex flex-wrap gap-4 items-end"><input type="hidden" id="account-id"><div class="flex-1 min-w-[150px]"><label for="account-name">Nome da Conta</label><input type="text" id="account-name" required class="w-full mt-1 bg-slate-700 rounded h-10 px-3"></div><div class="flex-1 min-w-[150px]"><label for="account-balance">Saldo Inicial</label><input type="number" step="0.01" id="account-balance" required class="w-full mt-1 bg-slate-700 rounded h-10 px-3" value="0"></div><button type="submit" class="btn btn-primary h-10">Salvar Conta</button></form><div class="flex justify-end mt-6"><button type="button" class="btn btn-secondary close-modal-btn">Fechar</button></div></div>`;
             const modal = showModal(html);
             const renderList = () => {
                 modal.querySelector('#accounts-list-modal').innerHTML = state.accounts.map(acc => `<div class="flex justify-between items-center bg-slate-800 p-2 rounded"><span>${acc.name} (${formatCurrency(acc.initialBalance)})</span><div><button class="edit-account-btn text-blue-400 mr-2" data-id="${acc.id}">Editar</button><button class="delete-account-btn text-red-400" data-id="${acc.id}">X</button></div></div>`).join('');
             };
             renderList();

             modal.querySelector('.close-modal-btn').onclick = () => hideModal(modal);
             modal.querySelector('form').onsubmit = e => {
                 e.preventDefault();
                 const form = e.target;
                 const id = form['account-id'].value;
                 const account = {
                     id: id ? Number(id) : Date.now(),
                     name: form['account-name'].value.trim(),
                     initialBalance: parseFloat(form['account-balance'].value)
                 };
                 if (id) {
                     state.accounts = state.accounts.map(a => a.id === account.id ? account : a);
                 } else {
                     state.accounts.push(account);
                 }
                 form.reset();
                 form['account-id'].value = '';
                 renderList();
                 updateAndRender();
             };
        };
        const openCategoriesModal = () => {
            const html = `<div class="card w-full max-w-2xl"><h2 class="text-2xl font-bold mb-4">Gerir Categorias</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="space-y-4"><h3>Receitas</h3><div id="receita-list" class="space-y-2 max-h-40 overflow-y-auto pr-2"></div><form class="category-form flex gap-2"><input type="hidden" name="type" value="receita"><input type="text" name="name" placeholder="Nova Categoria" required class="flex-grow bg-slate-700 rounded h-10 px-3"><button type="submit" class="btn btn-primary h-10">+</button></form></div><div class="space-y-4"><h3>Despesas</h3><div id="despesa-list" class="space-y-2 max-h-40 overflow-y-auto pr-2"></div><form class="category-form flex gap-2"><input type="hidden" name="type" value="despesa"><input type="text" name="name" placeholder="Nova Categoria" required class="flex-grow bg-slate-700 rounded h-10 px-3"><button type="submit" class="btn btn-primary h-10">+</button></form></div></div><div class="flex justify-end mt-6"><button type="button" class="btn btn-secondary close-modal-btn">Fechar</button></div></div>`;
            const modal = showModal(html);
            const renderCategoryLists = () => {
                modal.querySelector('#receita-list').innerHTML = state.categories.receita.map(c => `<div class="flex justify-between items-center bg-slate-800 p-2 rounded"><span>${c}</span><button class="delete-category-btn text-red-400" data-type="receita" data-name="${c}">X</button></div>`).join('');
                modal.querySelector('#despesa-list').innerHTML = state.categories.despesa.map(c => `<div class="flex justify-between items-center bg-slate-800 p-2 rounded"><span>${c}</span><button class="delete-category-btn text-red-400" data-type="despesa" data-name="${c}">X</button></div>`).join('');
            };
            renderCategoryLists();
            modal.querySelector('.close-modal-btn').onclick = () => hideModal(modal);
            modal.querySelectorAll('.category-form').forEach(form => form.onsubmit = e => {
                e.preventDefault();
                const type = form.type.value;
                const name = form.name.value.trim();
                if (name && !state.categories[type].includes(name)) {
                    state.categories[type].push(name);
                }
                form.reset();
                renderCategoryLists();
                updateAndRender();
            });
        };
        const openGoalsModal = () => {
            const html = `<div class="card w-full max-w-lg"><h2 class="text-2xl font-bold mb-4">Gerir Metas</h2><div id="goals-list-modal" class="mb-4 max-h-48 overflow-y-auto pr-2"></div><h3 class="font-semibold mb-2 text-lg">Nova / Editar Meta</h3><form id="goal-form" class="flex flex-wrap gap-4 items-end"><input type="hidden" id="goal-id"><div class="flex-1 min-w-[150px]"><label for="goal-name">Nome da Meta</label><input type="text" id="goal-name" required class="w-full mt-1 bg-slate-700 rounded h-10 px-3"></div><div class="flex-1 min-w-[150px]"><label for="goal-amount">Valor Total</label><input type="number" step="0.01" id="goal-amount" required class="w-full mt-1 bg-slate-700 rounded h-10 px-3" value="0"></div><button type="submit" class="btn btn-primary h-10">Salvar Meta</button></form><div class="flex justify-end mt-6"><button type="button" class="btn btn-secondary close-modal-btn">Fechar</button></div></div>`;
            const modal = showModal(html);
            const renderList = () => {
                modal.querySelector('#goals-list-modal').innerHTML = state.goals.map(goal => `<div class="flex justify-between items-center bg-slate-800 p-2 rounded"><span>${goal.name} (${formatCurrency(goal.targetAmount)})</span><div><button class="edit-goal-btn text-blue-400 mr-2" data-id="${goal.id}">Editar</button><button class="delete-goal-btn text-red-400" data-id="${goal.id}">X</button></div></div>`).join('');
            };
            renderList();
            modal.querySelector('.close-modal-btn').onclick = () => hideModal(modal);
            modal.querySelector('form').onsubmit = e => {
                e.preventDefault();
                const form = e.target;
                const id = form['goal-id'].value;
                const goal = { id: id ? Number(id) : Date.now(), name: form['goal-name'].value.trim(), targetAmount: parseFloat(form['goal-amount'].value) };
                if (id) {
                    state.goals = state.goals.map(g => g.id === goal.id ? goal : g);
                } else {
                    state.goals.push(goal);
                }
                form.reset();
                form['goal-id'].value = '';
                renderList();
                updateAndRender();
            };
        };
        const openContributionModal = (goalId) => {
            const goal = state.goals.find(g => g.id === goalId);
            if (!goal) return;
            const accountOptions = state.accounts.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
            const html = `<div class="card w-full max-w-md"><h2 class="text-2xl font-bold mb-4">Contribuir para ${goal.name}</h2><form id="contribution-form" class="space-y-4"><div class="grid grid-cols-2 gap-4"><div><label for="contribution-amount">Valor</label><input type="number" step="0.01" id="contribution-amount" required class="w-full mt-1 bg-slate-700 rounded h-10 px-3"></div><div><label for="contribution-account">Da Conta</label><select id="contribution-account" class="w-full mt-1 bg-slate-700 rounded h-10 px-3">${accountOptions}</select></div></div><div class="flex justify-end space-x-4 pt-4"><button type="button" class="btn btn-secondary close-modal-btn">Cancelar</button><button type="submit" class="btn btn-primary">Adicionar</button></div></form></div>`;
            const modal = showModal(html);
            modal.querySelector('.close-modal-btn').onclick = () => hideModal(modal);
            modal.querySelector('form').onsubmit = e => {
                e.preventDefault();
                const contribution = {
                    id: Date.now(),
                    tipo: 'despesa',
                    accountId: Number(document.getElementById('contribution-account').value),
                    categoria: 'Aportes para Metas',
                    nome: `Aporte para ${goal.name}`,
                    valor: parseFloat(document.getElementById('contribution-amount').value),
                    data: getTodayISO(),
                    goalId: goalId
                };
                state.allTransactions.push(contribution);
                updateAndRender();
                hideModal(modal);
            };
        };

        const setupEventListeners = () => {
            document.getElementById('prev-month').addEventListener('click', () => { state.currentDate.setMonth(state.currentDate.getMonth() - 1); updateAndRender(); });
            document.getElementById('next-month').addEventListener('click', () => { state.currentDate.setMonth(state.currentDate.getMonth() + 1); updateAndRender(); });
            document.getElementById('open-transaction-modal-btn').addEventListener('click', () => openTransactionModal());
            document.getElementById('open-transfer-modal-btn').addEventListener('click', () => openTransferModal());
            document.getElementById('manage-accounts-btn').addEventListener('click', openAccountsModal);
            document.getElementById('manage-categories-btn').addEventListener('click', openCategoriesModal);
            document.getElementById('manage-goals-btn').addEventListener('click', openGoalsModal);

            document.body.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                if (button.matches('.edit-btn')) {
                    const transaction = state.allTransactions.find(t => t.id === Number(button.dataset.id));
                    if (transaction.tipo === 'transferencia') openTransferModal(transaction);
                    else openTransactionModal(transaction);
                }
                if (button.matches('.delete-btn')) {
                    if (confirm('Tem a certeza?')) {
                        state.allTransactions = state.allTransactions.filter(t => t.id !== Number(button.dataset.id));
                        updateAndRender();
                    }
                }
                if (button.matches('.contribute-btn')) {
                    openContributionModal(Number(button.dataset.id));
                }
                if (button.matches('.edit-account-btn')) {
                    const modal = el.modalContainer.querySelector('.modal-overlay');
                    const account = state.accounts.find(a => a.id === Number(button.dataset.id));
                    const form = modal.querySelector('#account-form');
                    form['account-id'].value = account.id;
                    form['account-name'].value = account.name;
                    form['account-balance'].value = account.initialBalance;
                }
                if (button.matches('.delete-account-btn')) {
                    if (confirm('Tem a certeza? Isto apagará também as transações associadas.')) {
                        const id = Number(button.dataset.id);
                        state.accounts = state.accounts.filter(a => a.id !== id);
                        state.allTransactions = state.allTransactions.filter(t => t.accountId !== id && t.fromAccountId !== id && t.toAccountId !== id);
                        openAccountsModal();
                        updateAndRender();
                    }
                }
                if (button.matches('.delete-category-btn')) {
                    const {type, name} = button.dataset;
                    state.categories[type] = state.categories[type].filter(c => c !== name);
                    openCategoriesModal();
                    updateAndRender();
                }
                if (button.matches('.edit-goal-btn')) {
                    const modal = el.modalContainer.querySelector('.modal-overlay');
                    const goal = state.goals.find(g => g.id === Number(button.dataset.id));
                    const form = modal.querySelector('#goal-form');
                    form['goal-id'].value = goal.id;
                    form['goal-name'].value = goal.name;
                    form['goal-amount'].value = goal.targetAmount;
                }
                if (button.matches('.delete-goal-btn')) {
                    if (confirm('Tem a certeza? Apagar uma meta não irá apagar as suas contribuições.')) {
                        state.goals = state.goals.filter(g => g.id !== Number(button.dataset.id));
                        openGoalsModal();
                        updateAndRender();
                    }
                }
            });
        };
        
        const initApp = () => {
            loadData();
            setupEventListeners();
            renderApp();
        };

        initApp();
    });
    </script>
</body>
</html>

